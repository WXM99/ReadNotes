# Chp14 Transaction

## 定义

全部发生, 或者全部不发生的一组操作单元集合

```sql
begin transaction
-- sql
end transaction
```

- atomic 原子性: 任何失败都要撤销操作, 保证执行单元的“全或无”
- consistency 一致性: 数据库信息熵守恒
- isolation 隔离性: 事物的执行, 不能看作是被其他操作分隔开的; 不能被并发执行的操作干扰
- durability 持久性: 回复后事务操作持久

## isolation

### serializable

严格的串行化事务调度

### repeatable read

- 某个事务读取的数据项必须是别的事务已提交的, 否则读不到
- 事务内两次读取数据项期间, 其他事务不得更新该数据项

### read committed

- 某个事务读取的数据项必须是别的事务已提交的, 否则读不到
- 重复读相同数据项时不作要求

### read uncommitted 

- 可以读取别的事务未提交的数据项

### write

- 所有隔离级别不允许脏写: 其他没有完成事务写入的数据项,不得再次写

### 幻读

是指当事务不是独立执行时发生的一种现象，例如第一个事务对一个表中的数据进行了修改，这种修改涉及到表中的全部数据行。 同时，第二个事务也修改这个表中的数据，这种修改是向表中插入一行新数据。那么，以后就会发生操作第一个事务的用户发现表中还有没有修改的数据行，就好象 发生了幻觉一样。例如，一个编辑人员更改作者提交的文档，但当生产部门将其更改内容合并到该文档的主复本时，发现作者已将未编辑的新材料添加到该文档中。 如果在编辑人员和生产部门完成对原始文档的处理之前，任何人都不能将新材料添加到文档中，则可以避免该问题。

## 补充 

基于元数据的 Spring 声明性事务 :

Isolation 属性一共支持五种事务设置，具体介绍如下：

l          DEFAULT 使用数据库设置的隔离级别 ( 默认 ) ，由 DBA 默认的设置来决定隔离级别 .

l          READ_UNCOMMITTED 会出现脏读、不可重复读、幻读 ( 隔离级别最低，并发性能高 )

l          READ_COMMITTED  会出现不可重复读、幻读问题（锁定正在读取的行）

l          REPEATABLE_READ 会出幻读（锁定所读取的所有行）

l          SERIALIZABLE 保证所有的情况不会发生（锁表）

**不可重复读的重点是修改** **:** 
同样的条件 ,   你读取过的数据 ,   再次读取出来发现值不一样了 
**幻读的重点在于新增或者删除** 
同样的条件 ,   第 1 次和第 2 次读出来的记录数不一样



